@TaskMasterPro_Api_HostAddress_Http = http://localhost:5266
@TaskMasterPro_Api_HostAddress_Https = https://localhost:7058
@TaskMasterPro_Api_HostAddress_Docker = http://localhost:5001

### Variables
@baseUrl = {{TaskMasterPro_Api_HostAddress_Http}}/api
@testUserId = user-{{$randomInt}}

### Test Tenant IDs (from seeded data)
@acmeTenantId = 11111111-1111-1111-1111-111111111111
@techInnovationsTenantId = 22222222-2222-2222-2222-222222222222
@acmeUserId = 11111111-1111-1111-1111-111111111112
@techUserId = 22222222-2222-2222-2222-222222222222

### Authentication Tokens
### Create JWT tokens with different roles and tenant access:

### System Admin Token (can access all tenants) (domain: admin.taskmasterpro.com)
### dotnet user-jwts create --scope "taskmasterpro-api" --claim "role=SystemAdmin" --claim "tenant_id=11111111-1111-1111-1111-111111111111" --claim "name=System Admin" --claim "email=admin@system.com" --name "SystemAdmin" --project "demo/TaskMasterPro.Api"
@systemAdminJwt = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IlN5c3RlbUFkbWluIiwic3ViIjoiU3lzdGVtQWRtaW4iLCJqdGkiOiIzMGNlMGQ0Iiwic2NvcGUiOiJ0YXNrbWFzdGVycHJvLWFwaSIsInJvbGUiOiJTeXN0ZW1BZG1pbiIsInRlbmFudF9pZCI6IjExMTExMTExLTExMTEtMTExMS0xMTExLTExMTExMTExMTExMSIsIm5hbWUiOiJTeXN0ZW0gQWRtaW4iLCJlbWFpbCI6ImFkbWluQHN5c3RlbS5jb20iLCJhdWQiOlsiaHR0cDovL2xvY2FsaG9zdDo1MjY2IiwiaHR0cHM6Ly9sb2NhbGhvc3Q6NzA1OCJdLCJuYmYiOjE3NTUzNTgxODksImV4cCI6MTc2MzMwNjk4OSwiaWF0IjoxNzU1MzU4MTkwLCJpc3MiOiJkb3RuZXQtdXNlci1qd3RzIn0.FMsR_g1Add8wrL2X1IJtMwRqMBYwk7sKSLqPjvHqno4

### Regular User Token - Acme Corporation (domain: acme.taskmasterpro.com)
### dotnet user-jwts create --scope "taskmasterpro-api" --scope "read" --claim "role=Member" --claim "tenant_id=11111111-1111-1111-1111-111111111111" --claim "name=John Doe" --claim "email=john.doe@acme.com" --name "AcmeUser" --project "demo/TaskMasterPro.Api"
@acmeUserJwt = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IkFjbWVVc2VyIiwic3ViIjoiQWNtZVVzZXIiLCJqdGkiOiI3OWU0NmQwMiIsInNjb3BlIjpbInRhc2ttYXN0ZXJwcm8tYXBpIiwicmVhZCJdLCJyb2xlIjoiTWVtYmVyIiwidGVuYW50X2lkIjoiMTExMTExMTEtMTExMS0xMTExLTExMTEtMTExMTExMTExMTExIiwibmFtZSI6IkpvaG4gRG9lIiwiZW1haWwiOiJqb2huLmRvZUBhY21lLmNvbSIsImF1ZCI6WyJodHRwOi8vbG9jYWxob3N0OjUyNjYiLCJodHRwczovL2xvY2FsaG9zdDo3MDU4Il0sIm5iZiI6MTc1NTQwMDkxNywiZXhwIjoxNzYzMzQ5NzE3LCJpYXQiOjE3NTU0MDA5MTgsImlzcyI6ImRvdG5ldC11c2VyLWp3dHMifQ.Twf83GDETZMNogkJESYYjY7fBFDaK2ymk5c8QQWNXHg

### Project Manager Token - Acme Corporation  (domain: acme.taskmasterpro.com)
### dotnet user-jwts create --scope "taskmasterpro-api" --scope "read" --scope "write" --claim "role=ProjectManager" --claim "tenant_id=11111111-1111-1111-1111-111111111111" --claim "name=Jane Smith" --claim "email=jane.smith@acme.com" --name "AcmeProjectManager" --project "demo/TaskMasterPro.Api"
@acmeProjectManagerJwt = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IkFjbWVQcm9qZWN0TWFuYWdlciIsInN1YiI6IkFjbWVQcm9qZWN0TWFuYWdlciIsImp0aSI6IjM2ZWRiYTE1Iiwic2NvcGUiOlsidGFza21hc3RlcnByby1hcGkiLCJyZWFkIiwid3JpdGUiXSwicm9sZSI6IlByb2plY3RNYW5hZ2VyIiwidGVuYW50X2lkIjoiMTExMTExMTEtMTExMS0xMTExLTExMTEtMTExMTExMTExMTExIiwibmFtZSI6IkphbmUgU21pdGgiLCJlbWFpbCI6ImphbmUuc21pdGhAYWNtZS5jb20iLCJhdWQiOlsiaHR0cDovL2xvY2FsaG9zdDo1MjY2IiwiaHR0cHM6Ly9sb2NhbGhvc3Q6NzA1OCJdLCJuYmYiOjE3NTU0MDA4NTYsImV4cCI6MTc2MzM0OTY1NiwiaWF0IjoxNzU1NDAwODU3LCJpc3MiOiJkb3RuZXQtdXNlci1qd3RzIn0.1zL6fFaScFi8VU52l7wsYUkiyrxGsyM3zHhMldbH_G8

### Regular User Token - Tech Innovations (domain: techinnovations.taskmasterpro.com)
### dotnet user-jwts create --scope "taskmasterpro-api" --scope "read" --claim "role=Member" --claim "tenant_id=22222222-2222-2222-2222-222222222222" --claim "name=Bob Wilson" --claim "email=bob.wilson@techinnovations.com" --name "TechUser" --project "demo/TaskMasterPro.Api"
@techUserJwt = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IlRlY2hVc2VyIiwic3ViIjoiVGVjaFVzZXIiLCJqdGkiOiI4MzRjMDQ3NiIsInNjb3BlIjpbInRhc2ttYXN0ZXJwcm8tYXBpIiwicmVhZCJdLCJyb2xlIjoiTWVtYmVyIiwidGVuYW50X2lkIjoiMjIyMjIyMjItMjIyMi0yMjIyLTIyMjItMjIyMjIyMjIyMjIyIiwibmFtZSI6IkJvYiBXaWxzb24iLCJlbWFpbCI6ImJvYi53aWxzb25AdGVjaGlubm92YXRpb25zLmNvbSIsImF1ZCI6WyJodHRwOi8vbG9jYWxob3N0OjUyNjYiLCJodHRwczovL2xvY2FsaG9zdDo3MDU4Il0sIm5iZiI6MTc1NTQwMDc4OCwiZXhwIjoxNzYzMzQ5NTg4LCJpYXQiOjE3NTU0MDA3ODgsImlzcyI6ImRvdG5ldC11c2VyLWp3dHMifQ.QGRqyo9Jrt1hgr2R-d69L1Z1akyRz3r3uO-XY3BOSjw

### Invalid/Expired Token for negative testing (domain: admin.taskmasterpro.com)
@invalidJwt = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJpbnZhbGlkIn0.invalid

### =================================================================
### 🛡️ ADMIN ENDPOINTS - CROSS-TENANT ACCESS TESTS
### =================================================================

### ✅ TEST 1: GetAllCompanies - System Admin Success
# Expected: 200 OK
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com

### ❌ TEST 2: GetAllCompanies - Regular User Forbidden (Acme)
# Expected: 403 Forbidden
# @name GetCompaniesRegularUser
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{acmeUserJwt}}
Host: acme.taskmasterpro.com

### ❌ TEST 3: GetAllCompanies - Project Manager Forbidden
# Expected: 403 Forbidden
# @name GetCompaniesProjectManager  
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{acmeProjectManagerJwt}}
Host: acme.taskmasterpro.com

### ❌ TEST 4: GetAllCompanies - Different Tenant User Forbidden
# Expected: 403 Forbidden
# @name GetCompaniesDifferentTenant
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{techUserJwt}}
Host: techinnovations.taskmasterpro.com

### ❌ TEST 5: GetAllCompanies - No Authentication
# Expected: 401 Unauthorized
# @name GetCompaniesNoAuth
GET {{baseUrl}}/admin/companies
Host: admin.taskmasterpro.com

### ❌ TEST 6: GetAllCompanies - Invalid Token
# Expected: 401 Unauthorized
# @name GetCompaniesInvalidToken
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{invalidJwt}}
Host: admin.taskmasterpro.com

### =================================================================
### 🔍 AUDIT LOGS TESTS
### =================================================================

### ✅ TEST 7: GetAuditLogs - System Admin Success (All logs)
# Expected: 200 OK
# @name GetAuditLogsAll
GET {{baseUrl}}/admin/audit-logs
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com

### ❌ TEST 8: GetAuditLogs - Regular User Forbidden
# Expected: 403 Forbidden
# @name GetAuditLogsRegularUser
GET {{baseUrl}}/admin/audit-logs
Authorization: Bearer {{acmeUserJwt}}
Host: acme.taskmasterpro.com

### ❌ TEST 9: GetAuditLogs - Project Manager Forbidden
# Expected: 403 Forbidden
# @name GetAuditLogsProjectManager
GET {{baseUrl}}/admin/audit-logs
Authorization: Bearer {{acmeProjectManagerJwt}}
Host: acme.taskmasterpro.com

### =================================================================
### 📊 TENANT STATISTICS TESTS
### =================================================================

### ✅ TEST 10: GetTenantStats - System Admin Success
# Expected: 200 OK
# @name GetTenantStatsSuccess
GET {{baseUrl}}/admin/tenant-statistics
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com

### ❌ TEST 11: GetTenantStats - Regular User Forbidden
# Expected: 403 Forbidden
# @name GetTenantStatsRegularUser
GET {{baseUrl}}/admin/tenant-statistics
Authorization: Bearer {{acmeUserJwt}}
Host: acme.taskmasterpro.com

### ❌ TEST 12: GetTenantStats - Project Manager Forbidden
# Expected: 403 Forbidden
# @name GetTenantStatsProjectManager
GET {{baseUrl}}/admin/tenant-statistics
Authorization: Bearer {{acmeProjectManagerJwt}}
Host: acme.taskmasterpro.com

### ❌ TEST 13: GetTenantStats - Cross-Tenant User Forbidden
# Expected: 403 Forbidden
# @name GetTenantStatsCrossTenant
GET {{baseUrl}}/admin/tenant-statistics
Authorization: Bearer {{techUserJwt}}
Host: techinnovations.taskmasterpro.com

### =================================================================
### 👤 USER MIGRATION TESTS
### =================================================================

### ✅ TEST 14: MigrateUser - System Admin Success
# Expected: 200 OK
# @name MigrateUserSuccess
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "{{acmeTenantId}}",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### ✅ TEST 15: MigrateUser - Migrate Back (Rollback previous test)
# Expected: 200 OK
# @name MigrateUserRollback
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "{{techInnovationsTenantId}}",
  "toTenantId": "{{acmeTenantId}}"
}

### ❌ TEST 16: MigrateUser - Non-Existent User
# Expected: 404 Not Found
# @name MigrateUserNotFound
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com
Content-Type: application/json

{
  "userId": "99999999-9999-9999-9999-999999999999",
  "fromTenantId": "{{acmeTenantId}}",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### ❌ TEST 17: MigrateUser - Invalid Tenant IDs
# Expected: 404 Not Found
# @name MigrateUserInvalidTenant
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "99999999-9999-9999-9999-999999999999",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### ❌ TEST 18: MigrateUser - Regular User Forbidden
# Expected: 403 Forbidden
# @name MigrateUserRegularUserForbidden
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{acmeUserJwt}}
Host: acme.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "{{acmeTenantId}}",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### ❌ TEST 19: MigrateUser - Project Manager Forbidden
# Expected: 403 Forbidden
# @name MigrateUserProjectManagerForbidden
POST {{baseUrl}}/admin/migrate-user
Authorization: Bearer {{acmeProjectManagerJwt}}
Host: acme.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "{{acmeTenantId}}",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### ❌ TEST 20: MigrateUser - Missing Authorization Header
# Expected: 401 Unauthorized
# @name MigrateUserNoAuth
POST {{baseUrl}}/admin/migrate-user
Host: admin.taskmasterpro.com
Content-Type: application/json

{
  "userId": "{{acmeUserId}}",
  "fromTenantId": "{{acmeTenantId}}",
  "toTenantId": "{{techInnovationsTenantId}}"
}

### =================================================================
### 🌐 SUBDOMAIN-BASED TENANT RESOLUTION TESTS
### =================================================================

### ✅ TEST 21: Companies via ACME subdomain (System Admin)
# Expected: 200 OK
# @name GetCompaniesByAcmeSubdomain
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{systemAdminJwt}}
Host: acme.taskmasterpro.com

### ✅ TEST 22: Companies via Tech Innovations subdomain (System Admin)
# Expected: 200 OK
# @name GetCompaniesByTechSubdomain
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{systemAdminJwt}}
Host: techinnovations.taskmasterpro.com

### ❌ TEST 23: Companies via invalid subdomain
# Expected: 400 Bad Request or 404 Not Found
# @name GetCompaniesByInvalidSubdomain
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{systemAdminJwt}}
Host: nonexistent.taskmasterpro.com

### ❌ TEST 24: Companies via www subdomain (should be excluded)
# Expected: 400 Bad Request
# @name GetCompaniesByWwwSubdomain
GET {{baseUrl}}/admin/companies
Authorization: Bearer {{systemAdminJwt}}
Host: www.taskmasterpro.com

### =================================================================
### 🔄 CROSS-TENANT OPERATION VALIDATION TESTS
### =================================================================

### ✅ TEST 25: Verify audit log creation after migration
# Expected: 200 OK
# @name VerifyAuditLogAfterMigration
GET {{baseUrl}}/admin/audit-logs?tenantId={{acmeTenantId}}&take=5
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com

### ✅ TEST 26: Verify tenant statistics include all tenants
# Expected: 200 OK
# @name VerifyTenantStatsIncludeAll
GET {{baseUrl}}/admin/tenant-statistics
Authorization: Bearer {{systemAdminJwt}}
Host: admin.taskmasterpro.com